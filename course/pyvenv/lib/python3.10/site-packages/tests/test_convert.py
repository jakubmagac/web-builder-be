from io import StringIO

from it4kt import convert


def test_skeleton_conversion():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'>
        <title>Nadpis scenára</title>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Nadpis scenára
---

## Ciele"""


def test_metadata_conversion():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'
        week="3"
        publication-week="1">
        <title>Nadpis scenára</title>
        <subtitle>Podnadpis scenára</subtitle>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Nadpis scenára
Podnadpis: Podnadpis scenára
Týždeň: 3
Týždeň-zverejnenia: 1
---

## Ciele"""


def test_introduction_conversion():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'>
        <title>Nadpis scenára</title>
        <introduction>Úvod scenára</introduction>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Nadpis scenára
---

## Ciele



## Úvod

Úvod scenára"""


def test_objectives_conversion():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'>
        <title>Nadpis scenára</title>
        <objective id="prvy">Prvý cieľ</objective>
        <objective id="druhy">Druhý cieľ</objective>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Nadpis scenára
---

## Ciele

  1. {prvy} Prvý cieľ
  2. {druhy} Druhý cieľ"""


def test_steps_conversion():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'>
        <title>Nadpis scenára</title>
        <objective id="prvy">Prvý cieľ</objective>
        <objective id="druhy">Druhý cieľ</objective>

        <step></step>
        <step objectives="prvy"></step>
        <step objectives="prvy druhy">
            <title>Nadpis kroku</title>
        </step>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Nadpis scenára
---

## Ciele

  1. {prvy} Prvý cieľ
  2. {druhy} Druhý cieľ


## Krok

## Krok {prvy}

## Krok: Nadpis kroku {prvy druhy}"""


def test_paragraph_conversion():
    xml = """
    <step xmlns='http://kpi.fei.tuke.sk/practices'>
    <p>A paragraph of text.</p>
    </step>
    """
    assert to_markdown(xml) == """## Krok

A paragraph of text."""


def test_free_text_conversion():
    xml = """
    <step xmlns='http://kpi.fei.tuke.sk/practices'>
    An unmarked paragraph of text.
    </step>
    """
    assert to_markdown(xml) == """## Krok

An unmarked paragraph of text."""


def test_task_conversion():
    xml = """
    <task xmlns='http://kpi.fei.tuke.sk/practices'>
    A task
    </task>
    """
    assert to_markdown(xml) == "> Úloha:\n> A task"


def test_comment_conversion():
    xml = """
    <comment xmlns='http://kpi.fei.tuke.sk/practices'>
    A comment
    </comment>
    """
    assert to_markdown(xml) == "> Poznámka:\n> A comment"


def test_warning_conversion():
    xml = """
    <warning xmlns='http://kpi.fei.tuke.sk/practices'>
    A warning
    </warning>
    """
    assert to_markdown(xml) == "> Upozornenie:\n> A warning"


def test_solution_conversion():
    xml = """
    <task xmlns='http://kpi.fei.tuke.sk/practices'>
    A task
    <solution>A solution</solution>
    </task>
    """
    assert to_markdown(xml) == "> Úloha:\n> A task\n\n> Riešenie:\n> A solution"


def test_hidden_solution_conversion():
    xml = """
    <task xmlns='http://kpi.fei.tuke.sk/practices'>
    A task
    <solution hidden="true">A solution</solution>
    </task>
    """
    assert to_markdown(xml) == "> Úloha:\n> A task\n\n> Riešenie*:\n> A solution"


def test_result_conversion():
    xml = """
    <task xmlns='http://kpi.fei.tuke.sk/practices'>
    A task
    <result>A result</result>
    </task>
    """
    assert to_markdown(xml) == "> Úloha:\n> A task\n\n> Výsledok:\n> A result"


def test_hidden_result_conversion():
    xml = """
    <task xmlns='http://kpi.fei.tuke.sk/practices'>
    A task
    <result hidden="true">A result</result>
    </task>
    """
    assert to_markdown(xml) == "> Úloha:\n> A task\n\n> Výsledok*:\n> A result"


def test_code_conversion():
    xml = """
    <code xmlns='http://kpi.fei.tuke.sk/practices'
        display="block" lang="python">
print("Hello world")
</code>
"""
    assert to_markdown(xml) == """
```python
print("Hello world")
```"""


def test_code_without_language():
    xml = """
    <code xmlns='http://kpi.fei.tuke.sk/practices'
        display="block">
print("Hello world")
</code>
"""
    assert to_markdown(xml) == """
```
print("Hello world")
```"""


def test_html_conversion():
    xml = """
    <step xmlns='http://kpi.fei.tuke.sk/practices'
        xmlns:h='http://www.w3.org/1999/xhtml'>
    <h:p><h:b>A</h:b> <h:strong>paragraph</h:strong> <h:i>of</h:i> <h:em>text</h:em>.</h:p>
    </step>
    """
    assert to_markdown(xml) == """## Krok

**A** **paragraph** _of_ _text_."""


def test_html_without_prefixes():
    xml = """
    <step xmlns='http://kpi.fei.tuke.sk/practices'>
    <p>A <strong>paragraph</strong> of <em>text</em>.</p>
    </step>
    """
    assert to_markdown(xml) == """## Krok

A **paragraph** of _text_."""


def test_resources_conversion():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'>
        <title>Test</title>
        <resource>First resource</resource>
        <resource>Second resource</resource>
        <additional>
            <resource>Additional resource</resource>
        </additional>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Test
---

## Ciele



## Zdroje

  1. First resource
  2. Second resource


## Doplňujúce zdroje

  1. Additional resource"""


def test_additional_tasks_conversion():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'>
        <title>Test</title>
        <additional>
            <task>Additional task</task>
        </additional>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Test
---

## Ciele



## Doplňujúce úlohy

> Úloha:
> Additional task"""


def test_figure_conversion():
    xml = """
    <step xmlns='http://kpi.fei.tuke.sk/practices'>
        <figure>
            <image>images/image.png</image>
        </figure>
    </step>
    """
    assert to_markdown(xml) == """## Krok

![](images/image.png)"""


def test_figure_with_caption_conversion():
    xml = """
    <step xmlns='http://kpi.fei.tuke.sk/practices'>
        <figure>
            <image>images/image.png</image>
            <caption>Caption</caption>
        </figure>
    </step>
    """
    assert to_markdown(xml) == """## Krok

![Caption](images/image.png)"""


def test_objectives_conversion_from_experimental_format():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'>
        <title>Nadpis scenára</title>
        <objectives>
            <objective id="prvy">Prvý cieľ</objective>
            <objective id="druhy">Druhý cieľ</objective>
        </objectives>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Nadpis scenára
---

## Ciele

  1. {prvy} Prvý cieľ
  2. {druhy} Druhý cieľ"""


def test_about_conversion():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'>
        <title>Nadpis scenára</title>
        <about>Úvod scenára</about>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Nadpis scenára
---

## Ciele



## Úvod

Úvod scenára"""


def test_steps_conversion_from_experimental_format():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'>
        <title>Nadpis scenára</title>
        <objectives>
            <objective id="prvy">Prvý cieľ</objective>
            <objective id="druhy">Druhý cieľ</objective>
        </objectives>

        <content>
            <step></step>
            <step objectives="prvy"></step>
            <step objectives="prvy druhy">
                <title>Nadpis kroku</title>
            </step>
        </content>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Nadpis scenára
---

## Ciele

  1. {prvy} Prvý cieľ
  2. {druhy} Druhý cieľ


## Krok

## Krok {prvy}

## Krok: Nadpis kroku {prvy druhy}"""


def test_task_conversion_from_experimental_format():
    xml = """
    <task xmlns='http://kpi.fei.tuke.sk/practices'>
        <problem>A task</problem>
        <description>Description</description>
    </task>
    """
    assert to_markdown(xml) == """> Úloha:
> A task

Description"""


def test_additional_links_and_tasks_conversion_from_experimental_format():
    xml = """
    <module xmlns='http://kpi.fei.tuke.sk/practices'>
        <title>Test</title>
        <additional-tasks>
            <additional-task>Additional task</additional-task>
        </additional-tasks>
        <additional-links>
            <additional-link>First resource</additional-link>
            <additional-link>Second resource</additional-link>
        </additional-links>
    </module>
    """
    assert to_markdown(xml) == """---
Nadpis: Test
---

## Ciele



## Doplňujúce úlohy

> Úloha:
> Additional task

## Doplňujúce zdroje

  1. First resource
  2. Second resource"""


def test_code_conversion_from_experimental_format():
    xml = '<code xmlns="http://kpi.fei.tuke.sk/practices" lang="python">' \
          'print("Hello world")</code>'
    assert to_markdown(xml) == """
```python
print("Hello world")
```"""


def test_special_tags_conversion():
    xml = """
    <p xmlns='http://kpi.fei.tuke.sk/practices'>
        <command>print</command> <keyword>hello</keyword> <emph>world</emph>
    </p>"""
    assert to_markdown(xml) == "`print` **hello** _world_"


def test_alert_conversion():
    xml = """
    <alert xmlns='http://kpi.fei.tuke.sk/practices'>
    A warning
    </alert>
    """
    assert to_markdown(xml) == "> Upozornenie:\n> A warning"


def test_page_conversion():
    xml = """
<page xmlns='http://kpi.fei.tuke.sk/practices'>
    <title>Main title</title>
    <section>
        <title>Section title</title>
        <p>Section text</p>
    </section>
    <section>
        <title>Second section</title>
        <p>Text</p>
        <section>
            <title>Subsection</title>
            <p>Subsection text</p>
        </section>
    </section>
</page>
    """
    assert to_markdown(xml) == """---
Nadpis: Main title
---

## Section title

Section text

## Second section

Text

### Subsection

Subsection text"""


def to_markdown(xml):
    text = convert.xml_to_markdown(StringIO(xml)).rstrip()
    # print(text)
    return text
