from it4kt.configuration import (
    read_configuration,
    configure_theme,
    configure_filesystem,
    read_translation_configuration,
)
from pathlib import Path
from unittest.mock import patch
import pytest
import shutil
import it4kt
import os


@pytest.fixture(autouse=True)
def default_configuration():
    yield
    it4kt.env.reset()


@pytest.fixture
def tmp_course_dir(tmpdir):
    """Create empty directory and "cd" into it."""
    original_dir = os.getcwd()
    os.chdir(str(tmpdir))
    tmpdir.ensure('content', dir=True)
    yield tmpdir
    os.chdir(original_dir)


@pytest.fixture
def default_theme():
    original_theme = it4kt.env.theme
    it4kt.env.theme = configure_theme()
    yield
    it4kt.env.theme = original_theme


@pytest.fixture
def example_course():
    original_dir = os.getcwd()
    os.chdir('example-course')
    read_configuration()
    read_translation_configuration()
    it4kt.i18n.change_language('sk')
    configure_filesystem()
    yield
    shutil.rmtree('output', ignore_errors=True)
    shutil.rmtree('latex-output', ignore_errors=True)
    os.chdir(original_dir)


@pytest.fixture
def testing_course():
    original_dir = os.getcwd()
    os.chdir(Path('tests', 'testing-course'))
    read_configuration()
    read_translation_configuration()
    it4kt.i18n.change_language('sk')
    configure_filesystem()
    yield
    shutil.rmtree('output', ignore_errors=True)
    shutil.rmtree('latex-output', ignore_errors=True)
    os.chdir(original_dir)


@pytest.fixture
def i18n_course():
    original_dir = os.getcwd()
    os.chdir(Path('tests', 'i18n-course'))
    read_configuration()
    yield
    shutil.rmtree('output', ignore_errors=True)
    os.chdir(original_dir)


@pytest.fixture
def i18n_nonfallback_course():
    with patch("it4kt.configuration.CONFIGURATION_FILE", Path('it4kt.nonfallback.yml')):
        original_dir = os.getcwd()
        os.chdir(Path('tests', 'i18n-course'))
        read_configuration()
        yield
        shutil.rmtree('output', ignore_errors=True)
        os.chdir(original_dir)
