from pathlib import Path
from it4kt.readers import XMLScenarioReader, XMLReader
from .utils import assert_xml_equals, filesystem_find

REFERENCE_XML_PATH = Path('labs', 'reference.xml')
REFERENCE_HTML_PATH = Path('..', '..', 'docs', 'html-structure.html')


def test_xml_scenario_reader(testing_course):
    reader = XMLScenarioReader()
    course_path = filesystem_find(REFERENCE_XML_PATH)
    scenario = reader.read(course_path)
    assert scenario.title == "Príklad použitia elementov scenára"
    assert "<section class=\"step\"" in scenario.content
    assert "Stručný úvod do problematiky" in scenario.content


def test_xml_scenario_reader_lecturer_content(testing_course):
    course_path = filesystem_find(REFERENCE_XML_PATH)
    scenario = XMLScenarioReader().read(course_path)
    assert "Text viditeľný iba pre vyučujúceho." in scenario.lecturer_content
    assert "Text viditeľný iba pre vyučujúceho." not in scenario.student_content


def test_html_output_matches_specification(testing_course):
    course_path = filesystem_find(REFERENCE_XML_PATH)
    scenario = XMLScenarioReader().read(course_path)
    reference = REFERENCE_HTML_PATH.read_text(encoding='utf-8')
    assert_xml_equals(reference, scenario.lecturer_content)


def test_xml_page_reader(testing_course):
    reader = XMLReader('page.xsl')
    course_path = filesystem_find(Path('example-page.xml'))
    page = reader.read(course_path)
    assert page.title == 'Príklad stránky v XML'
    assert len(page.element_tree.findall('section')) == 2


def test_week_from_attribute(testing_course):
    reader = XMLScenarioReader()
    course_path = filesystem_find(REFERENCE_XML_PATH)
    scenario2 = reader.read(course_path)
    assert scenario2.week == 2


def test_week_from_attribute_shadows_filename(testing_course):
    reader = XMLScenarioReader()
    # Scenario 03.xml intentionally specifies week 4
    course_path = filesystem_find(Path('labs', '03.xml'))
    scenario3 = reader.read(course_path)
    assert scenario3.week == 4


def test_week_from_filename(testing_course):
    reader = XMLScenarioReader()
    course_path = filesystem_find(Path('labs', '02.xml'))
    scenario1 = reader.read(course_path)
    assert scenario1.week == 2


def test_publication_week_from_attribute(testing_course):
    reader = XMLScenarioReader()
    course_path = filesystem_find(REFERENCE_XML_PATH)

    scenario2 = reader.read(course_path)
    assert scenario2.publication_week == 1


def test_subject_info_reading(testing_course):
    """
    XMLReader should automatically detect subjectInfo document and switch template.
    """
    reader = XMLReader('page.xsl')
    course_path = filesystem_find(Path('info.xml'))
    page = reader.read(course_path)
    assert page.title == "Priklad informácií o predmete"
    assert len(page.element_tree.findall('section')) == 4
