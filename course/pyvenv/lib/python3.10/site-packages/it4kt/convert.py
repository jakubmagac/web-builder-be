import re
import pkg_resources
from typing import IO

from lxml import etree
import html2text


def xml_to_markdown(file: IO) -> str:
    html = _xml_to_html(file)
    markdown = _html_to_markdown(html)
    return _postprocess_markdown(markdown)


def _xml_to_html(file: IO) -> str:
    with pkg_resources.resource_stream('it4kt', 'xsl/html-markdown.xsl') as f:
        xml_tree = etree.parse(file)  # fromstring(bytes(xml, encoding='utf-8'))
        xslt_tree = etree.parse(f)
        transform = etree.XSLT(xslt_tree)
        return str(transform(xml_tree))


def _html_to_markdown(html: str) -> str:
    text_maker = html2text.HTML2Text()
    text_maker.body_width = 0
    return text_maker.handle(html)


def _postprocess_markdown(markdown: str) -> str:
    markdown = markdown.replace('  \n', '\n').replace(' \n', '\n') \
        .replace('\n\n\n', '\n\n').replace('\\---\n', '---\n') \
        .replace('\n    ', '\n').replace('\n>     ', '\n> ')
    return re.sub(r'^>  (?=\w)', '> ', markdown, flags=re.MULTILINE)
